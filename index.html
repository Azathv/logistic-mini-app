<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>YuklaGo</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body {
  background:#0f0f0f;
  color:white;
  font-family:Arial;
  padding:15px;
}

h2 { text-align:center; }

button {
  width:100%;
  padding:22px;
  margin:12px 0;
  font-size:20px;
  font-weight:600;
  background:#2ea6ff;
  color:white;
  border:none;
  border-radius:16px;
}

input {
  width:100%;
  padding:14px;
  margin:8px 0;
  border-radius:10px;
  border:none;
  font-size:16px;
}

.card {
  background:#1c1c1c;
  padding:12px;
  margin-top:12px;
  border-radius:10px;
}

.hidden { display:none; }

.hint {
  font-size:12px;
  color:#aaa;
  font-style:italic;
  margin-bottom:6px;
}

.time {
  font-size:12px;
  color:rgba(255,255,255,0.5);
  margin-top:6px;
}

.header {
  display:flex;
  align-items:center;
  gap:10px;
  margin-bottom:20px;
}

.avatar {
  width:42px;
  height:42px;
  border-radius:50%;
}
</style>
</head>

<body>

<div class="header" id="userHeader"></div>

<div id="home">
  <button onclick="openAdd()">‚ûï Yuk joylash</button>
  <button onclick="openList()">üì¶ Yuklar</button>
</div>

<div id="add" class="hidden">
  <input id="from" placeholder="Qayerdan">
  <input id="to" placeholder="Qayerga">
  <input id="weight" placeholder="Yuk (masalan: 3 tonna)">

  <label>
    <input type="checkbox" id="useTg" checked>
    Telegram orqali bog‚Äòlanish
  </label>

  <div class="hint">Tg useringiz ko‚Äòrinishi uchun belgini yoqing</div>

  <input id="contact" placeholder="Telegram yoki telefon raqam">

  <button onclick="save()">Saqlash</button>
  <button onclick="back()">‚Üê Orqaga</button>
</div>

<div id="list" class="hidden"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  getDocs,
  query,
  where,
  orderBy
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCyuEl9ikVisF06WYVPJgc73xblH3yL3Q8",
  authDomain: "yukbor-d494b.firebaseapp.com",
  projectId: "yukbor-d494b",
  storageBucket: "yukbor-d494b.firebasestorage.app",
  messagingSenderId: "148070622007",
  appId: "1:148070622007:web:c5edc5088fffafd170b0b2"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Telegram user info
if (window.Telegram?.WebApp) {
  Telegram.WebApp.expand();
  const user = Telegram.WebApp.initDataUnsafe?.user;

  if (user) {
    userHeader.innerHTML = `
      <img class="avatar" src="https://t.me/i/userpic/320/${user.username}.jpg">
      <div>Salom, <b>${user.first_name}</b></div>
    `;
    if (user.username) {
      contact.value = "@" + user.username;
    }
  }
}

// Sahifa holatini saqlash
function setPage(p) {
  localStorage.setItem("page", p);
}

function restorePage() {
  const p = localStorage.getItem("page");
  if (p === "add") openAdd();
  else if (p === "list") openList();
}
restorePage();

window.openAdd = function () {
  hideAll();
  add.classList.remove("hidden");
  setPage("add");
};

window.openList = async function () {
  hideAll();
  list.innerHTML = "<h3>üì¶ Yuklar</h3>";
  setPage("list");

  const limitTime = Date.now() - (72 * 60 * 60 * 1000);

  const q = query(
    collection(db, "loads"),
    where("time", ">=", limitTime),
    orderBy("time", "desc")
  );

  const snap = await getDocs(q);

  if (snap.empty) {
    list.innerHTML += "<p>Hozircha yuk yo‚Äòq</p>";
  }

  snap.forEach(d => {
    const l = d.data();
    const date = new Date(l.time);
    const formattedTime =
      date.toLocaleDateString("uz-UZ") +
      " ¬∑ " +
      date.toLocaleTimeString("uz-UZ", { hour: "2-digit", minute: "2-digit" });

    list.innerHTML += `
      <div class="card">
        <b>${l.from} ‚Üí ${l.to}</b><br>
        Yuk: ${l.weight}<br>
        Aloqa: ${l.contact}
        <div class="time">${formattedTime}</div>
      </div>
    `;
  });

  list.innerHTML += `<button onclick="back()">‚Üê Orqaga</button>`;
  list.classList.remove("hidden");
};

window.save = async function () {
  if (!from.value || !to.value || !weight.value) {
    alert("Hamma maydonni to‚Äòldiring");
    return;
  }

  let contactValue = "Aloqa yo‚Äòq";
  if (useTg.checked) {
    contactValue = contact.value || "Telegram orqali";
  }

  await addDoc(collection(db, "loads"), {
    from: from.value,
    to: to.value,
    weight: weight.value,
    contact: contactValue,
    time: Date.now()
  });

  back();
};

window.back = function () {
  hideAll();
  home.classList.remove("hidden");
  setPage("home");
};

function hideAll() {
  home.classList.add("hidden");
  add.classList.add("hidden");
  list.classList.add("hidden");
}
</script>

</body>
</html>
