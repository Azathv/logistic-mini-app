<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Logistika</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body { background:#0f0f0f; color:white; font-family:Arial; padding:15px; }
    h2 { text-align:center; }
    button {
      width:100%; padding:14px; margin:8px 0; font-size:16px;
      background:#2ea6ff; color:white; border:none; border-radius:10px;
    }
    input {
      width:100%; padding:10px; margin:6px 0;
      border-radius:8px; border:none;
    }
    .card {
      background:#1c1c1c; padding:10px;
      margin-top:10px; border-radius:8px;
    }
    .hidden { display:none; }
    .hint {
      font-size:12px;
      color:#aaa;
      font-style:italic;
      margin-bottom:6px;
    }
  </style>
</head>

<body>

<h2>üöö Logistika</h2>

<div id="home">
  <button onclick="openAdd()">‚ûï Yuk joylash</button>
  <button onclick="openList()">üì¶ Yuklar</button>
</div>

<div id="add" class="hidden">
  <input id="from" placeholder="Qayerdan">
  <input id="to" placeholder="Qayerga">
  <input id="weight" placeholder="Yuk (masalan: 3 tonna)">

  <label>
    <input type="checkbox" id="useTg" checked>
    Telegram orqali bog‚Äòlanish
  </label>
  <div class="hint">
    Tg useringiz ko‚Äòrinishi uchun belgini yoqing
  </div>

  <input id="contact" placeholder="Telegram yoki telefon raqam">

  <button onclick="save()">Saqlash</button>
  <button onclick="back()">‚Üê Orqaga</button>
</div>

<div id="list" class="hidden"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    query,
    where
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCyuEl9ikVisF06WYVPJgc73xblH3yL3Q8",
    authDomain: "yukbor-d494b.firebaseapp.com",
    projectId: "yukbor-d494b",
    storageBucket: "yukbor-d494b.firebasestorage.app",
    messagingSenderId: "148070622007",
    appId: "1:148070622007:web:c5edc5088fffafd170b0b2"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Telegram user avtomat qo‚Äòyiladi
  if (window.Telegram?.WebApp) {
    Telegram.WebApp.expand();
    const user = Telegram.WebApp.initDataUnsafe?.user;
    if (user?.username) {
      contact.value = "@" + user.username;
    }
  }

  window.openAdd = function () {
    hideAll();
    add.classList.remove("hidden");
  };

  // üî• 72 SOATLIK YUKLARNI CHIQARISH
  window.openList = async function () {
    hideAll();
    list.innerHTML = "<h3>üì¶ Yuklar</h3>";

    const now = Date.now();
    const limitTime = now - (72 * 60 * 60 * 1000);

    const q = query(
      collection(db, "loads"),
      where("time", ">=", limitTime)
    );

    const snap = await getDocs(q);

    if (snap.empty) {
      list.innerHTML += "<p>Hozircha yuk yo‚Äòq</p>";
    }

    snap.forEach(d => {
      const l = d.data();
      list.innerHTML += `
        <div class="card">
          <b>${l.from} ‚Üí ${l.to}</b><br>
          Yuk: ${l.weight}<br>
          Aloqa: ${l.contact}
        </div>
      `;
    });

    list.innerHTML += `<button onclick="back()">‚Üê Orqaga</button>`;
    list.classList.remove("hidden");
  };

  // üíæ SAQLASH
  window.save = async function () {
    if (!from.value || !to.value || !weight.value) {
      alert("Hamma maydonni to‚Äòldiring");
      return;
    }

    let contactValue = "Aloqa yo‚Äòq";
    if (useTg.checked) {
      contactValue = contact.value || "Telegram orqali";
    }

    await addDoc(collection(db, "loads"), {
      from: from.value,
      to: to.value,
      weight: weight.value,
      contact: contactValue,
      time: Date.now()
    });

    back();
  };

  window.back = function () {
    hideAll();
    home.classList.remove("hidden");
  };

  function hideAll() {
    home.classList.add("hidden");
    add.classList.add("hidden");
    list.classList.add("hidden");
  }
</script>
